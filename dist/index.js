(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.Cppkies=b())})(this,function(){'use strict';var y=Math.max;function a(a){return a instanceof Function?a():a}function b(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function c(c,d,e,f,g={}){for(const a in g)if(!/[a-zA-Z_$][0-9a-zA-Z_$]*/.test(a))throw new Error("Invalid context variable name!");let h=c.toString();const i=null===d;let j;i||(d=a(d),j="string"==typeof d?new RegExp(b(d),"g"):d),e=a(e);const k=/(\)[^{]*{)/,l=/(}?)$/;switch(i||j.test(h)||console.warn("Nothing to inject."),f){case"before":h=i?h.replace(k,`$1${e}`):h.replace(j,`${e}${d}`);break;case"replace":h=i?`${e}`:h.replace(j,`${e}`);break;case"after":h=i?h.replace(l,`${e}$1`):h.replace(j,`${d}${e}`);break;default:throw new Error("where Parameter must be \"before\", \"replace\" or \"after\"");}let m="";for(const a in g)m+=`var ${a} = globalThis.tempCtx.${a}\n`;globalThis.tempCtx=g;const n=new Function(`${m}globalThis.tempCtx = null\nreturn (${h})`)();return n.prototype=c.prototype,n}function d(a,b){for(const c in b)a[c]=b[c]}function e(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}function f(){Q.save=A={mods:{},foreign:D,saveVer:0,exists:!0}}function g(a){return A.foreign.buildings[a.name]||B}function h({amount:a,bought:b,free:c,totalCookies:d,level:e,muted:f,minigameSave:g,name:h}){A.foreign.buildings[h]={amount:a,bought:b,free:c,totalCookies:d,level:e,muted:f,minigameSave:g}}function j(a){return A.foreign.upgrades[a.name]||C}function k(a){A.foreign.upgrades[a.name]={unlocked:!!a.unlocked,bought:!!a.bought}}function l(){for(const a in Q.customBuildings){const b=Q.customBuildings[a];d(Game.Objects[b.name],g(b))}for(const a in Q.customUpgrades){const b=Q.customUpgrades[a];d(Game.Upgrades[b.name],j(b))}}function m(){for(const a in Q.customBuildings)h(Q.customBuildings[a]);for(const a in Q.customUpgrades)k(Q.customUpgrades[a])}function n(a){try{Q.save=A=JSON.parse(a),A.exists||f()}catch(a){f()}l()}function o(){return m(),JSON.stringify(A)}function p(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})}function q(a,b){E[a]=b}function r(a){if(F.includes(a))throw new Error("Recursive alias");return(F.push(a),a in E)?r(E[a]):(F=[],a)}function s(a){return new Promise(b=>{const c=new Image;c.addEventListener("load",()=>{b(c)}),c.crossOrigin="Anonymous",c.src=a})}function t(a){return new Promise(b=>{a.canvas.toBlob(a=>{b(URL.createObjectURL(a))})})}function u(a,b,c,d,e,f){return new Promise(g=>{c[0]instanceof Array||(c=[c]),c=c;const h={};for(const a in c)for(const d in c[a])if(c[a][d]){if(c[a][d]=c[a][d].toString().toLowerCase(),!(c[a][d]in b))throw new Error("Invalid icon name");h[c[a][d]]=[parseInt(d),parseInt(a)]}const j=document.createElement("canvas").getContext("2d"),k=new Image;k.addEventListener("load",()=>{for(const a in j.canvas.width=e[0],j.canvas.height=e[1],h)j.drawImage(k,h[a][0]*d[0],h[a][1]*d[1],d[0],d[1],b[a][0]*d[0],b[a][1]*d[1],d[0],d[1]);const a=()=>{t(j).then(g)};let c;f&&(c=f(j)),c instanceof Promise?c.then(a):a()}),k.crossOrigin="Anonymous",k.src=a})}function v(a){const b=[new z("tooltip",()=>{a.tooltip=c(c(a.tooltip,"return","let ret = ","replace"),null,`\n//Cppkies injection
		for(const i in Cppkies.buildingHooks["${a.name}"].tooltip) {
			const tempRet = Cppkies.buildingHooks["${a.name}"].tooltip[i].call(this, ret)
			ret = tempRet || ret
		}
		return ret`,"after")})],d={};b.forEach(a=>{d[a.value]=a.defValue,a.func&&a.func()}),K[a.name]=d}function w(a){return"fortune"===a.tier}function x(){Q.hooks.customGetIcon.push((a,b,c)=>(Q.customTiers.forEach(a=>{a.keyName===b.toString()&&a.iconLink&&(c[2]=a.iconLink)}),c),(a,b,c)=>(Q.customBuildings.forEach(b=>{b.name===a&&b.iconLink&&(c[2]=b.iconLink)}),c))}class z{constructor(a,b){this.value=a,this.func=b,this.defValue=[]}}let A=null;const B={amount:0,bought:0,free:0,totalCookies:0,level:0,muted:0,minigameSave:""},C={bought:!1,unlocked:!1},D={buildings:{},upgrades:{}},E={};let F=[];const G={},H={"3d":[0,21],milestone1:[0,22],milestone2:[0,23],milestone3:[0,24],krumblor:[0,25],level1:[0,26],level2:[0,27]},I={},J={research:[9,0],cookie:[10,0],mouse:[11,0],multicursor:[12,0],kitten:[18,0]},K={},L=[];class M extends Game.Object{constructor(a,b,c,d,e,f,h,j,k,l){for(const g in 0!==d[1]&&console.warn("All icon sheets must follow an order, see https://cppkies.js.org/#/CommonProblems#IconOrder?id=relink-column"),0!==e[0]&&console.warn("All big icon sheets must follow an order, see https://cppkies.js.org/#/CommonProblems#IconOrder?id=big-icons"),super(a,b,c,e[1],d[0],f,0,h,j),L.push(this),v(this),Game.ObjectsById){if(0>=parseInt(g))continue;const a=Game.ObjectsById[g];if(a.canvas=window.l(`rowCanvas${g}`),a.canvas&&(a.ctx=a.canvas.getContext("2d"),a.canvas.addEventListener("mouseover",()=>{a.mouseOn=!0}),a.canvas.addEventListener("mouseout",()=>{a.mouseOn=!1}),a.canvas.addEventListener("mousemove",b=>{const c=a.canvas.getBoundingClientRect();a.mousePos[0]=b.pageX-c.left,a.mousePos[1]=b.pageY-c.top}),a.minigame&&a.minigameLoaded)){const b=a.minigame.save();a.minigame.launch(),a.minigame.load(b)}}this.buildingLink=e[2]||Q.buildingLink+"",this.iconLink=r(d[2]||Q.iconLink+""),k&&(Game.foolObjects[a]=k),l&&(Game.goldenCookieBuildingBuffs[a]=l),this.iconLink&&K[this.name].tooltip.push(a=>this.locked?a:a.replace("background-position",`background-image:url(${this.iconLink});background-position`)),Game.BuildStore(),this.buildingLink&&Q.hooks.postBuildStore.push(()=>{window.l(`productIcon${this.id}`).style.backgroundImage=`url(${this.buildingLink})`,window.l(`productIconOff${this.id}`).style.backgroundImage=`url(${this.buildingLink})`}),Game.BuildStore(),this.canvas=window.l(`rowCanvas${this.id}`),this.ctx=this.canvas.getContext("2d"),this.pics=[];const m=document.createElement("div");m.className="tinyProductIcon",m.id=`mutedProduct${this.id}`,m.style.display="none",this.buildingLink&&(m.style.backgroundImage=`url(${this.buildingLink})`),m.style.backgroundPositionX=`-${d[0]}px`,m.style.backgroundPositionY=`-${d[1]}px`,m.addEventListener("click",()=>{this.mute(0),window.PlaySound(this.muted?"snd/clickOff.mp3":"snd/clickOn.mp3")}),window.AddEvent(this.canvas,"mouseover",()=>{this.mouseOn=!0}),window.AddEvent(this.canvas,"mouseout",()=>{this.mouseOn=!1}),this.canvas.addEventListener("mousemove",a=>{const b=this.canvas.getBoundingClientRect();this.mousePos[0]=a.pageX-b.left,this.mousePos[1]=a.pageY-b.top}),window.l("buildingsMute").appendChild(m);const n=g(this);for(const g in n)this[g]=n[g];Game.recalculateGains=1}}const N=[];class O extends Game.Upgrade{constructor(a,b,c,d,e=()=>{}){d[2]||(d[2]=Q.iconLink+""),d[2]=r(d[2]),super(a,"function"==typeof b?"":b,"function"==typeof c?0:c,"function"==typeof d?[0,0]:d,e),"function"==typeof b&&(this.descFunc=b),"function"==typeof c&&(this.priceFunc=c),"function"==typeof d&&(this.iconFunction=d),N.push(this);const f=j(this);for(const g in f)this[g]=f[g]}}const P=[];const Q={hooks:null,iconLink:"",buildingLink:"",buildingHooks:K,buildingHooksById:[],customBuildings:L,customUpgrades:N,customTiers:P,save:A,onLoad:[],Building:M,Upgrade:O,TieredUpgrade:class extends O{constructor(a,b,c,d){"string"==typeof c&&(c=Game.Objects[c]),super(a,`${e(c.plural)} are <b>twice</b> as efficient.<q>${b}</q>`,c.basePrice*Game.Tiers[d.toString()].price,Game.GetIcon(c.name,d)),Game.SetTier(c.name,d),this.buildingTie1=c,w(this)&&(this.order=19e3,c.fortune=this),isNaN(parseInt(d.toString()))||(d=parseInt(d.toString())),"number"==typeof d&&(this.order=100*(c.id+1)+d,this.order-=75*y(0,Math.min(c.id-4,3)))}},Tier:class{constructor(a,b,c,d=!1,e="auto",f=null,g=null,h=null,i="auto"){this.name=a,this.color=c,this.upgrades=[],this.special=d,this.keyName="auto"===i?d?a:(Object.keys(Game.Tiers).filter(a=>!isNaN(parseInt(a))).length+1).toString():i,null===f&&(this.unlock=-1),"number"==typeof f&&(this.unlock=f),(!1===d&&null===f||"auto"===f)&&(this.unlock=Game.Tiers[parseInt(this.keyName)-1].unlock+50),"number"==typeof g&&(this.achievUnlock=g),(!1===d&&null===g||"auto"===g)&&(this.achievUnlock=Game.Tiers[parseInt(this.keyName)-1].achievUnlock+50),h&&(this.req=h),this.price="auto"===e?1e8*Game.Tiers[Object.keys(Game.Tiers).filter(a=>!isNaN(parseInt(a))).length.toString()].price:e,this.iconRow=b[1],this.iconLink=r(b[2]||Q.iconLink+""),Game.Tiers[this.keyName]=this,P.push(this)}},HeavenlyUpgrade:class extends O{constructor(a,b,c,d,e,f=["Legacy"],g=()=>{}){super(a,b,c,d,g),this.pool="prestige",this.posX=e[0],this.posY=e[1],this.parents=f.map(a=>Game.Upgrades[a]||Game.UpgradesById[a]),Game.PrestigeUpgrades.push(this),Game.UpgradePositions[this.id]=e}},GrandmaSynergy:class extends O{constructor(a,b,c,d){"string"==typeof c&&(c=Game.Objects[c]);let f=c.id-1;f=1===f?"grandma":`${f} grandmas`,super(a,`Grandmas are <b>twice</b> as efficient.${e(c.plural)} gain <b>+1% CpS</b> per ${f}.<q>${b}</q>`,c.basePrice*Game.Tiers[2].price,[10,9],Game.Objects.Grandma.redraw),c.grandma=this,this.buildingTie=c,this.order=250+5*(c.id/12),Game.GrandmaSynergies.push(this.name),d&&Q.hooks.customGrandmaPic.push(()=>{if(this.bought)return d})}},SynergyUpgrade:class extends O{constructor(a,b,c,d,f){"string"==typeof c&&(c=Game.Objects[c]),"string"==typeof d&&(d=Game.Objects[d]),b=`${e(c.plural)} gain <b>+5% CpS</b> per ${d.name.toLowerCase()}.<br>${e(d.plural)} gain <b>+0.1% CpS</b> per 
			${c.name.toLowerCase()}.<q>${b}</q>`,super(a,b,(10*c.basePrice+1*d.basePrice)*Game.Tiers[f].price,Game.GetIcon(c.name,f)),this.tier=f,this.buildingTie1=c,this.buildingTie2=d,this.order=5e3,c.synergies.push(this),d.synergies.push(this)}},injectCode:c,DEFAULT_ONBUY:function(){Game.UnlockTiered(this),this.amount>=Game.SpecialGrandmaUnlock&&0<Game.Objects.Grandma.amount&&this.grandma&&Game.Unlock(this.grandma.name)},DEFAULT_CPS:a=>Game.GetTieredCpsMult(a)*Game.magicCpS(a.name)*a.baseCps,icons:{relinkColumn:function(a,b,c,d=!1){return p(this,void 0,void 0,function*(){c===void 0&&(!G[a]&&(G[a]=0),c=G[a]++);const e={};for(const a in H)e[a]=[c,H[a][1]];for(const a in Game.Tiers)e[Game.Tiers[a].name.toLowerCase()]=e[a.toString()]=[c,Game.Tiers[a].iconRow];q(a,(yield u(d?r(a):a,e,b,[48,48],[48*(c+1),48*(Object.values(e).reduce((a,b)=>y(a,b[1]),-Infinity)+1)],b=>new Promise(c=>{if(r(a)!==a){const d=new Image;d.addEventListener("load",()=>{b.drawImage(d,0,0),c()}),d.src=r(a),d.crossOrigin="Anonymous"}else c()}))))})},relinkRow:function(a,b,c,d=!1){return p(this,void 0,void 0,function*(){c===void 0&&(!I[a]&&(I[a]=0),c=I[a]++);const e={};for(const a in J)e[a]=[J[a][0],c];for(const a in Game.ObjectsById)e[Game.ObjectsById[a].single.toLowerCase()]=e[a]=[Game.ObjectsById[a].iconColumn,c];q(a,(yield u(d?r(a):a,e,b,[48,48],[48*(Object.values(e).reduce((a,b)=>y(a,b[0]),-Infinity)+1),48*(c+1)],b=>new Promise(c=>{if(r(a)!==a){const d=new Image;d.addEventListener("load",()=>{b.drawImage(d,0,0),c()}),d.src=r(a),d.crossOrigin="Anonymous"}else c()}))))})},patchIconsheet:function(a,b,c=!0){var d;return p(this,void 0,void 0,function*(){const e=document.createElement("canvas").getContext("2d"),f=yield s(c?r(a):a),g=[f.width,f.height];for(const a of b)48*a[0][0]>g[0]&&(g[0]=48*a[0][0]),48*a[0][1]>g[1]&&(g[1]=48*a[0][1]);e.canvas.width=g[0],e.canvas.height=g[1],e.drawImage(f,0,0);const h={};for(const a of b){const b=r((null!==(d=a[1][2])&&void 0!==d?d:Q.iconLink)||"img/icons.png");h[b]||(h[b]=yield s(b)),e.clearRect(48*a[0][0],48*a[0][1],48,48),e.drawImage(h[b],48*a[1][0],48*a[1][1],48,48,48*a[0][0],48*a[0][1],48,48)}q(a,(yield t(e)))})}}};let R;window.Cppkies?R=window.Cppkies:(R=Q,function(){return new Promise(a=>{const b={},d=[new z("customMenu",()=>{Game.UpdateMenu=c(Game.UpdateMenu,null,`
					// Cppkies injection
					switch (Game.onMenu) {
						case "prefs":
							for(const i in Cppkies.hooks.customOptionsMenu) Cppkies.hooks.customOptionsMenu[i]()
							break
						case "stats":
							for(const i in Cppkies.hooks.customStatsMenu) Cppkies.hooks.customStatsMenu[i]()
							break
						case "log":
							for(const i in Cppkies.hooks.customInfoMenu) Cppkies.hooks.customInfoMenu[i]()
							break
					}
					for(const i in Cppkies.hooks.customMenu) Cppkies.hooks.customMenu[i]()
					`,"before")}),new z("customOptionsMenu"),new z("customStatsMenu"),new z("customInfoMenu"),new z("customLoad",()=>{Game.LoadSave=c(Game.LoadSave,"if (Game.prefs.showBackupWarning==1)",`
					// Cppkies injection
					for(const i in Cppkies.hooks.customLoad) Cppkies.hooks.customLoad[i]()
					`,"before")}),new z("customReset",()=>{Game.Reset=c(Game.Reset,null,`
					// Cppkies injection
					for(const i in Cppkies.hooks.customReset) Cppkies.hooks.customReset[i](hard)
					`,"before")}),new z("customGetIcon",()=>{Game.GetIcon=c(Game.GetIcon,"return [col,Game.Tiers[tier].iconRow];",`
					// Cppkies Injection
					let icon = [col, Game.Tiers[tier].iconRow]
					for(const i in Cppkies.hooks.customGetIcon) icon = Cppkies.hooks.customGetIcon[i](type, tier, icon) || icon
					return icon
`,"replace")}),new z("postBuildStore",()=>{Game.BuildStore=c(Game.BuildStore,null,";\nfor(const i in Cppkies.hooks.postBuildStore) Cppkies.hooks.postBuildStore[i]()","after")}),new z("customGrandmaPic",()=>{Game.Objects.Grandma.art.pic=c(Game.Objects.Grandma.art.pic,"return choose(list)+'.png'",`// Cppkies injection
					list = list.concat(Cppkies.hooks.customGrandmaPic.map(val=> val()).filter(val => val))
					`,"before")})];d.forEach(a=>{var c;b[a.value]=a.defValue,null===(c=a.func)||void 0===c?void 0:c.call(a)}),Game.Loader.Load=c(Game.Loader.Load,"img.src=this.domain",`
			// Cppkies injection
			img.src = (assets[i].indexOf('http') !== -1 ? "" : this.domain)
`,"replace"),Game.Objects.Cursor.buyFunction=c(Game.Objects.Cursor.buyFunction,"Game.Unlock('Octillion fingers');",`
 			// Cppkies injection
			for(const i in this.tieredUpgrades) {
				if (isNaN(parseInt(i))) break
				if (this.amount >= Game.Tiers[this.tieredUpgrades[i].tier].unlock - 50) this.tieredUpgrades[i].unlock()
			}
`,"after"),a(b)})}().then(a=>{R.hooks=a,Game.Notify("Cppkies loaded!","",[32,17]),Game.modSaveData.cppkies||(Game.modSaveData.cppkies="{}"),Game.registerMod("cppkies",{save:o,load:n}),Game.Win("Third-party"),Q.onLoad.forEach(a=>a()),Q.onLoad=new Proxy(Q.onLoad,{set:(a,b,c)=>("length"!==b&&c(),!0)}),window.CPPKIES_ONLOAD||(window.CPPKIES_ONLOAD=[]),window.CPPKIES_ONLOAD.forEach(a=>a()),window.CPPKIES_ONLOAD=new Proxy(Q.onLoad,{set:(a,b,c)=>("length"!==b&&c(),!0)}),x(),window.Cppkies=R}));var S=R;return S});
//# sourceMappingURL=index.js.map
